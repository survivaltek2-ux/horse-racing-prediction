{% extends "base.html" %}

{% block title %}AI-Enhanced Prediction - {{ race.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-brain"></i>
                        AI-Enhanced Prediction
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Race Information -->
                    <div class="race-info mb-4">
                        <h4>{{ race.name }}</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Date:</strong> {{ race.date }}</p>
                                <p><strong>Track:</strong> {{ race.track }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Distance:</strong> {{ race.distance }}m</p>
                                <p><strong>Condition:</strong> {{ race.track_condition }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- AI Configuration Form -->
                    <form method="POST" id="aiPredictionForm">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-cogs"></i>
                                            AI Configuration
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="use_ai" name="use_ai" value="true" checked>
                                            <label class="form-check-label" for="use_ai">
                                                <strong>Enable AI Enhancement</strong>
                                                <small class="d-block text-muted">Use neural networks and deep learning models</small>
                                            </label>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="use_ensemble" name="use_ensemble" value="true" checked>
                                            <label class="form-check-label" for="use_ensemble">
                                                <strong>Ensemble Learning</strong>
                                                <small class="d-block text-muted">Combine multiple AI models for better accuracy</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-info-circle"></i>
                                            AI Features
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-unstyled mb-0">
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success"></i>
                                                Deep Neural Networks (DNN)
                                            </li>
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success"></i>
                                                LSTM for Form Analysis
                                            </li>
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success"></i>
                                                CNN Pattern Recognition
                                            </li>
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success"></i>
                                                AI-Powered Insights
                                            </li>
                                            <li class="mb-0">
                                                <i class="fas fa-check text-success"></i>
                                                Confidence Scoring
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('races') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i>
                                Back to Races
                            </a>
                            
                            <div>
                                <a href="{{ url_for('predict', race_id=race.id) }}" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-chart-line"></i>
                                    Standard Prediction
                                </a>
                                <button type="button" class="btn btn-primary" id="generateBtn" onclick="startAIPrediction()">
                                    <i class="fas fa-brain"></i>
                                    Generate AI Prediction
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- AI Information Card -->
            <div class="card mt-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb"></i>
                        About AI-Enhanced Predictions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-primary">Deep Learning</h6>
                            <p class="small">Advanced neural networks analyze complex patterns in racing data that traditional methods might miss.</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-primary">Form Analysis</h6>
                            <p class="small">LSTM networks examine sequential performance data to understand form trends and momentum.</p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-primary">Pattern Recognition</h6>
                            <p class="small">Convolutional networks identify hidden patterns in racing performance matrices.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="progressModalLabel">
                    <i class="fas fa-brain"></i>
                    AI Prediction in Progress
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="fas fa-cogs fa-3x text-primary mb-3"></i>
                    <h6 id="progressStatus">Initializing AI models...</h6>
                </div>
                
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                         role="progressbar" 
                         id="progressBar" 
                         style="width: 0%" 
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        <span id="progressText">0%</span>
                    </div>
                </div>
                
                <div class="small text-muted" id="progressDetails">
                    Please wait while our AI models analyze the race data...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentJobId = null;
let pollInterval = null;

function startAIPrediction() {
    const generateBtn = document.getElementById('generateBtn');
    const useAI = document.getElementById('use_ai').checked;
    const useEnsemble = document.getElementById('use_ensemble').checked;
    
    // Disable button and show loading state
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
    generateBtn.disabled = true;
    
    // Show progress modal
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    progressModal.show();
    
    // Reset progress
    updateProgress(0, 'Initializing AI models...', 'Starting prediction process...');
    
    // Start async prediction
    fetch(`/api/predict_ai_async/{{ race.id }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            use_ai: useAI,
            use_ensemble: useEnsemble
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentJobId = data.job_id;
        updateProgress(5, 'AI prediction started', 'Job ID: ' + currentJobId);
        
        // Start polling for status
        startPolling();
    })
    .catch(error => {
        console.error('Error starting prediction:', error);
        updateProgress(0, 'Error starting prediction', error.message);
        
        // Re-enable button
        generateBtn.innerHTML = '<i class="fas fa-brain"></i> Generate AI Prediction';
        generateBtn.disabled = false;
        
        // Hide modal after 3 seconds
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('progressModal')).hide();
        }, 3000);
    });
}

function startPolling() {
    if (!currentJobId) return;
    
    pollInterval = setInterval(() => {
        fetch(`/api/prediction_status/${currentJobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            const progress = data.progress || 0;
            let status = 'Processing...';
            let details = 'AI models are analyzing the race data...';
            
            switch (data.status) {
                case 'started':
                    status = 'Initializing AI models...';
                    details = 'Setting up neural networks and loading models...';
                    break;
                case 'processing':
                    if (progress < 30) {
                        status = 'Loading race data...';
                        details = 'Gathering and preprocessing race information...';
                    } else if (progress < 50) {
                        status = 'Running AI analysis...';
                        details = 'Deep learning models are processing the data...';
                    } else if (progress < 80) {
                        status = 'Generating predictions...';
                        details = 'Calculating probabilities and confidence scores...';
                    } else {
                        status = 'Finalizing results...';
                        details = 'Preparing prediction results and insights...';
                    }
                    break;
                case 'completed':
                    status = 'Prediction completed!';
                    details = 'Redirecting to results...';
                    stopPolling();
                    
                    // Redirect to results page
                    setTimeout(() => {
                        window.location.href = `/ai_prediction_results/{{ race.id }}`;
                    }, 1000);
                    break;
                case 'error':
                    status = 'Prediction failed';
                    details = data.error || 'An unknown error occurred';
                    stopPolling();
                    
                    // Re-enable button
                    const generateBtn = document.getElementById('generateBtn');
                    generateBtn.innerHTML = '<i class="fas fa-brain"></i> Generate AI Prediction';
                    generateBtn.disabled = false;
                    
                    // Hide modal after 3 seconds
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('progressModal')).hide();
                    }, 3000);
                    break;
            }
            
            updateProgress(progress, status, details);
        })
        .catch(error => {
            console.error('Error polling status:', error);
            stopPolling();
            
            updateProgress(0, 'Connection error', 'Failed to check prediction status');
            
            // Re-enable button
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.innerHTML = '<i class="fas fa-brain"></i> Generate AI Prediction';
            generateBtn.disabled = false;
            
            // Hide modal after 3 seconds
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('progressModal')).hide();
            }, 3000);
        });
    }, 1000); // Poll every second
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

function updateProgress(progress, status, details) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressStatus = document.getElementById('progressStatus');
    const progressDetails = document.getElementById('progressDetails');
    
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
    progressText.textContent = Math.round(progress) + '%';
    progressStatus.textContent = status;
    progressDetails.textContent = details;
    
    // Change color based on status
    if (progress >= 100) {
        progressBar.className = 'progress-bar bg-success';
    } else if (progress > 0) {
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
    } else {
        progressBar.className = 'progress-bar bg-danger';
    }
}

// Toggle ensemble option based on AI enablement
document.getElementById('use_ai').addEventListener('change', function() {
    const ensembleCheckbox = document.getElementById('use_ensemble');
    if (!this.checked) {
        ensembleCheckbox.checked = false;
        ensembleCheckbox.disabled = true;
    } else {
        ensembleCheckbox.disabled = false;
        ensembleCheckbox.checked = true;
    }
});

// Clean up polling when page is unloaded
window.addEventListener('beforeunload', function() {
    stopPolling();
});
</script>
{% endblock %}